<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro de Produtos - ILUMISOL</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#e0f7fa',
                            100: '#b3e5fc',
                            500: '#0288d1',
                            600: '#0277bd',
                            700: '#01579b'
                        },
                        success: {
                            500: '#4caf50',
                            600: '#388e3c'
                        }
                    },
                    fontFamily: {
                        'roboto': ['Roboto', 'sans-serif']
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gradient-to-br from-primary-50 to-primary-100 font-roboto text-gray-800 min-h-screen">

    <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <div class="fixed top-0 left-0 w-64 h-screen bg-gradient-to-b from-primary-500 to-primary-600 shadow-2xl z-50 overflow-y-auto">
        <div class="p-6">
            <h4 class="text-center text-white text-xl font-bold mb-8">
                <i class="fas fa-solar-panel mr-2"></i>ILUMISOL
            </h4>
            <nav class="space-y-2">
                <a href="orçamento.html" class="flex items-center px-4 py-3 text-white rounded-r-3xl transition-all duration-300 hover:bg-white hover:text-primary-500 hover:shadow-lg group">
                    <i class="fas fa-lightbulb mr-3 w-5"></i>
                    <span class="font-medium">ORÇAMENTO</span>
                </a>
                <a href="estoque.html" class="flex items-center px-4 py-3 text-white rounded-r-3xl transition-all duration-300 hover:bg-white hover:text-primary-500 hover:shadow-lg group">
                    <i class="fas fa-warehouse mr-3 w-5"></i>
                    <span class="font-medium">ESTOQUE</span>
                </a>
                <a href="produtos.html" class="flex items-center px-4 py-3 text-white rounded-r-3xl transition-all duration-300 hover:bg-white hover:text-primary-500 hover:shadow-lg group">
                    <i class="fas fa-box mr-3 w-5"></i>
                    <span class="font-medium">PRODUTOS</span>
                </a>
                <a href="cadastro.html" class="flex items-center px-4 py-3 bg-white text-primary-500 rounded-r-3xl shadow-lg font-medium">
                    <i class="fas fa-plus mr-3 w-5"></i>
                    <span>CADASTRO</span>
                </a>
                <a href="marcas.html" class="flex items-center px-4 py-3 text-white rounded-r-3xl transition-all duration-300 hover:bg-white hover:text-primary-500 hover:shadow-lg group">
                    <i class="fas fa-tags mr-3 w-5"></i>
                    <span class="font-medium">MARCAS</span>
                </a>
                <a href="precos.html" class="flex items-center px-4 py-3 text-white rounded-r-3xl transition-all duration-300 hover:bg-white hover:text-primary-500 hover:shadow-lg group">
                    <i class="fas fa-dollar-sign mr-3 w-5"></i>
                    <span class="font-medium">PREÇOS</span>
                </a>
            </nav>
        </div>
    </div>

    <div class="ml-64 p-8">
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-800 flex items-center">
                <i class="fas fa-plus text-primary-500 mr-4"></i>
                Cadastro de Produtos
            </h1>
            <p class="text-gray-600 mt-2">Selecione o tipo de produto e preencha as informações</p>
        </div>

        <div class="bg-white rounded-3xl shadow-2xl border border-gray-100 overflow-hidden">
            <div class="p-8">
                <div class="text-center mb-8">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-2 flex items-center justify-center">
                        <i class="fas fa-plus-circle text-success-500 mr-3"></i>
                        Adicionar Novo Produto
                    </h2>
                </div>

                <form id="product-form">
                    <div class="mb-8">
                        <h3 class="text-xl font-semibold text-gray-700 mb-6 text-center">Selecione o Tipo de Produto</h3>
                        <div class="grid grid-cols-1 md:grid-cols-4 lg:grid-cols-7 gap-6">
                            <div class="product-card product-card-hover cursor-pointer p-6 rounded-2xl border-2 border-gray-200 text-center hover:border-blue-500 hover:shadow-xl transition-all duration-300" data-product-type="inversores" role="radio" aria-checked="false" tabindex="0">
                                <i class="fas fa-plug text-4xl text-blue-500 mb-4"></i>
                                <h6 class="font-semibold text-gray-700">Inversor</h6>
                            </div>
                            <div class="product-card product-card-hover cursor-pointer p-6 rounded-2xl border-2 border-gray-200 text-center hover:border-blue-500 hover:shadow-xl transition-all duration-300" data-product-type="modulos" role="radio" aria-checked="false" tabindex="0">
                                <i class="fas fa-solar-panel text-4xl text-yellow-500 mb-4"></i>
                                <h6 class="font-semibold text-gray-700">Módulo</h6>
                            </div>
                            <div class="product-card product-card-hover cursor-pointer p-6 rounded-2xl border-2 border-gray-200 text-center hover:border-blue-500 hover:shadow-xl transition-all duration-300" data-product-type="baterias" role="radio" aria-checked="false" tabindex="0">
                                <i class="fas fa-battery-full text-4xl text-green-500 mb-4"></i>
                                <h6 class="font-semibold text-gray-700">Bateria</h6>
                            </div>
                            <div class="product-card product-card-hover cursor-pointer p-6 rounded-2xl border-2 border-gray-200 text-center hover:border-blue-500 hover:shadow-xl transition-all duration-300" data-product-type="acessorios_baterias" role="radio" aria-checked="false" tabindex="0">
                                <i class="fas fa-bolt text-4xl text-orange-500 mb-4"></i>
                                <h6 class="font-semibold text-gray-700">Acessórios p/ Baterias</h6>
                            </div>
                            <div class="product-card product-card-hover cursor-pointer p-6 rounded-2xl border-2 border-gray-200 text-center hover:border-blue-500 hover:shadow-xl transition-all duration-300" data-product-type="estruturas" role="radio" aria-checked="false" tabindex="0">
                                <i class="fas fa-bars-staggered text-4xl text-gray-500 mb-4"></i>
                                <h6 class="font-semibold text-gray-700">Estrutura</h6>
                            </div>
                            <div class="product-card product-card-hover cursor-pointer p-6 rounded-2xl border-2 border-gray-200 text-center hover:border-blue-500 hover:shadow-xl transition-all duration-300" data-product-type="acessorios_inversores" role="radio" aria-checked="false" tabindex="0">
                                <i class="fas fa-microchip text-4xl text-teal-500 mb-4"></i>
                                <h6 class="font-semibold text-gray-700">Acessórios p/ Inversores</h6>
                            </div>
                            <div class="product-card product-card-hover cursor-pointer p-6 rounded-2xl border-2 border-gray-200 text-center hover:border-blue-500 hover:shadow-xl transition-all duration-300" data-product-type="outros" role="radio" aria-checked="false" tabindex="0">
                                <i class="fas fa-tools text-4xl text-purple-500 mb-4"></i>
                                <h6 class="font-semibold text-gray-700">Outros</h6>
                            </div>
                        </div>
                    </div>

                    <div id="form-fields-container" class="hidden">
                        <input type="hidden" id="productType" name="productType">

                        <div class="mb-8">
                            <h4 class="text-lg font-semibold text-blue-700 mb-4 pb-2 border-b-2 border-blue-200">
                                <i class="fas fa-info-circle mr-2"></i>
                                Informações Básicas
                            </h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label for="model" class="block text-sm font-medium text-gray-700 mb-2">Modelo</label>
                                    <input type="text" id="model" name="model" required class="form-input-focus w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label for="manufacturer" class="block text-sm font-medium text-gray-700 mb-2">Fabricante</label>
                                    <select id="manufacturer" name="manufacturer" required class="form-input-focus w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                        <option value="">Carregando marcas...</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="erp_code" class="block text-sm font-medium text-gray-700 mb-2">Código ERP</label>
                                    <input type="text" id="erp_code" name="erp_code" class="form-input-focus w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                </div>
                                <div id="warranty_field">
                                    <label for="warranty" class="block text-sm font-medium text-gray-700 mb-2">Garantia (Anos)</label>
                                    <input type="text" inputmode="numeric" id="warranty" name="warranty" class="form-input-focus w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                </div>
                                <div id="module_dimensions_field" class="hidden">
                                    <label for="module_dimensions" class="block text-sm font-medium text-gray-700 mb-2">Dimensões (mm x mm x mm)</label>
                                    <input type="text" id="module_dimensions" name="module_dimensions" class="form-input-focus w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                </div>
                                <div id="frame_field" class="hidden">
                                    <label for="frame" class="block text-sm font-medium text-gray-700 mb-2">Frame</label>
                                    <input type="text" id="frame" name="frame" class="form-input-focus w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                </div>
                                <div id="battery-warranty-fields" class="hidden col-span-2">
                                    <div class="grid grid-cols-2 gap-4">
                                        <div>
                                            <label for="warranty_years" class="block text-sm font-medium text-gray-700 mb-2">Garantia (Anos)</label>
                                            <input type="text" inputmode="numeric" id="warranty_years" name="warranty_years" class="form-input-focus w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                        </div>
                                        <div>
                                            <label for="warranty_cycles" class="block text-sm font-medium text-gray-700 mb-2">Garantia (Ciclos)</label>
                                            <input type="text" inputmode="numeric" id="warranty_cycles" name="warranty_cycles" class="form-input-focus w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                        </div>
                                    </div>
                                </div>
                                <div class="col-span-2">
                                    <label for="description" class="block text-sm font-medium text-gray-700 mb-2">Descrição</label>
                                    <textarea id="description" name="description" rows="3" class="form-input-focus w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                                </div>
                            </div>
                        </div>

                        <div id="inverter-fields" class="hidden">
                            <h4 class="text-lg font-semibold text-blue-700 mb-4 pb-2 border-b-2 border-blue-200">
                                <i class="fas fa-bolt mr-2"></i>
                                Características AC
                            </h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
                                <div>
                                    <label for="inverter_type" class="block text-sm font-medium text-gray-700 mb-2">Tipo de Inversor</label>
                                    <select id="inverter_type" name="inverter_type" class="form-input-focus w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                        <option value="">Selecione...</option>
                                        <option value="String Off Grid">Inversor String Off Grid</option>
                                        <option value="Hibrido">Inversor Híbrido</option>
                                        <option value="On-Grid">Inversor On-Grid</option>
                                        <option value="Micro Inversor On-Grid">Micro Inversor On-Grid</option>
                                        <option value="Micro Inversor Hibrido">Micro Inversor Híbrido</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="nominal_power" class="block text-sm font-medium text-gray-700 mb-2">Potência Nominal (W)</label>
                                    <input type="text" inputmode="numeric" id="nominal_power" name="nominal_power" class="form-input-focus w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Rede</label>
                                    <div id="rede-tags-container" class="flex flex-wrap gap-2 p-2 min-h-[44px] border border-gray-300 rounded-xl bg-white form-input-focus focus-within:ring-2 focus-within:ring-blue-500 focus-within:border-transparent">
                                    </div>
                                    <input type="hidden" id="rede-hidden-input" name="rede">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Tensão</label>
                                    <div id="voltage-tags-container" class="flex flex-wrap gap-2 p-2 min-h-[44px] border border-gray-300 rounded-xl bg-white form-input-focus focus-within:ring-2 focus-within:ring-blue-500 focus-within:border-transparent">
                                        <span class="text-gray-400 text-sm">Selecione a rede primeiro...</span>
                                    </div>
                                    <input type="hidden" id="voltage-hidden-input" name="voltage">
                                </div>
                                <div>
                                    <label for="overload" class="block text-sm font-medium text-gray-700 mb-2">Overload (%)</label>
                                    <input type="text" inputmode="numeric" id="overload" name="overload" class="form-input-focus w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                </div>
                            </div>

                            <h4 class="text-lg font-semibold text-blue-700 mb-4 pb-2 border-b-2 border-blue-200">
                                <i class="fas fa-battery-half mr-2"></i>
                                Características DC
                            </h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                <div>
                                    <label for="start_voltage" class="block text-sm font-medium text-gray-700 mb-2">Tensão de Start (V)</label>
                                    <input type="text" inputmode="decimal" id="start_voltage" name="start_voltage" class="form-input-focus w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label for="min_op_voltage" class="block text-sm font-medium text-gray-700 mb-2">Tensão Mínima de Operação (V)</label>
                                    <input type="text" inputmode="decimal" id="min_op_voltage" name="min_op_voltage" class="form-input-focus w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label for="max_op_voltage" class="block text-sm font-medium text-gray-700 mb-2">Tensão Máxima de Operação (V)</label>
                                    <input type="text" inputmode="decimal" id="max_op_voltage" name="max_op_voltage" class="form-input-focus w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label for="isolation_voltage" class="block text-sm font-medium text-gray-700 mb-2">Tensão de Isolação (V)</label>
                                    <input type="text" inputmode="decimal" id="isolation_voltage" name="isolation_voltage" class="form-input-focus w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                </div>
                            </div>

                            <div id="advanced-inverter-fields" class="hidden">
                                <h5 class="text-md font-semibold text-blue-600 mb-4 pl-4 border-l-4 border-blue-300">
                                    <i class="fas fa-car-battery mr-2"></i>
                                    Características da Bateria
                                </h5>
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
                                    <div class="relative">
                                        <label for="compatible_batteries_label" class="block text-sm font-medium text-gray-700 mb-2">Baterias Compatíveis</label>
                                        <div id="selected-batteries-container" class="flex flex-wrap gap-2 p-2 min-h-[44px] border border-gray-300 rounded-xl form-input-focus focus-within:ring-2 focus-within:ring-blue-500 focus-within:border-transparent mb-2"></div>
                                        <input type="text" id="battery-search" placeholder="Buscar baterias..." class="w-full px-4 py-2 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                        <div id="suggestions-list" class="absolute z-10 w-full mt-1 bg-white border border-gray-200 rounded-xl shadow-lg max-h-48 overflow-y-auto hidden"></div>
                                        <input type="hidden" id="compatible_batteries" name="compatible_batteries">
                                    </div>
                                    <div>
                                        <label for="min_bat_voltage" class="block text-sm font-medium text-gray-700 mb-2">Tensão Mínima da Bateria (V)</label>
                                        <input type="text" inputmode="decimal" id="min_bat_voltage" name="min_bat_voltage" class="form-input-focus w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    </div>
                                    <div>
                                        <label for="max_bat_voltage" class="block text-sm font-medium text-gray-700 mb-2">Tensão Máxima da Bateria (V)</label>
                                        <input type="text" inputmode="decimal" id="max_bat_voltage" name="max_bat_voltage" class="form-input-focus w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    </div>
                                    <div>
                                        <label for="max_parallel" class="block text-sm font-medium text-gray-700 mb-2">Máximo de Inversores em Paralelo</label>
                                        <input type="text" inputmode="numeric" id="max_parallel" name="max_parallel" class="form-input-focus w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    </div>
                                </div>
                            </div>

                            <div id="mppt-section" class="hidden">
                                <h4 class="text-lg font-semibold text-blue-700 mb-4 pb-2 border-b-2 border-blue-200">
                                    <i class="fas fa-microchip mr-2"></i>
                                    MPPTs
                                </h4>
                                <div id="mppt-container" class="space-y-4"></div>
                                <button type="button" id="add-mppt" class="mt-4 px-6 py-2 bg-blue-500 text-white rounded-xl hover:bg-blue-600 transition-colors duration-200">
                                    <i class="fas fa-plus mr-2"></i>
                                    Adicionar MPPT
                                </button>
                            </div>
                        </div>

                        <div id="module-fields" class="hidden">
                            <h4 class="text-lg font-semibold text-blue-700 mb-4 pb-2 border-b-2 border-blue-200">
                                <i class="fas fa-solar-panel mr-2"></i>
                                Características DC
                            </h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                <div>
                                    <label for="module_power_wp" class="block text-sm font-medium text-gray-700 mb-2">Potência (Wp)</label>
                                    <input type="text" inputmode="numeric" id="module_power_wp" name="module_power_wp" class="form-input-focus w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label for="module_voltage_vmp" class="block text-sm font-medium text-gray-700 mb-2">Tensão Vmp (V)</label>
                                    <input type="text" inputmode="decimal" id="module_voltage_vmp" name="module_voltage_vmp" class="form-input-focus w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label for="module_voltage_voc" class="block text-sm font-medium text-gray-700 mb-2">Tensão Voc (V)</label>
                                    <input type="text" inputmode="decimal" id="module_voltage_voc" name="module_voltage_voc" class="form-input-focus w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label for="module_current_imp" class="block text-sm font-medium text-gray-700 mb-2">Corrente Imp (A)</label>
                                    <input type="text" inputmode="decimal" id="module_current_imp" name="module_current_imp" class="form-input-focus w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label for="module_current_isc" class="block text-sm font-medium text-gray-700 mb-2">Corrente Isc (A)</label>
                                    <input type="text" inputmode="decimal" id="module_current_isc" name="module_current_isc" class="form-input-focus w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                </div>
                            </div>
                        </div>

                        <div id="battery-fields" class="hidden">
                            <h4 class="text-lg font-semibold text-blue-700 mb-4 pb-2 border-b-2 border-blue-200">
                                <i class="fas fa-battery-full mr-2"></i>
                                Características DC
                            </h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label for="battery_type" class="block text-sm font-medium text-gray-700 mb-2">Tipo</label>
                                    <select id="battery_type" name="battery_type" class="form-input-focus w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                        <option value="">Selecione...</option>
                                        <option value="Chumbo-Ácido">Chumbo-Ácido</option>
                                        <option value="LFP">LFP</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="tensao_tipo" class="block text-sm font-medium text-gray-700 mb-2">Tipo de Tensão</label>
                                    <select id="tensao_tipo" name="tensao_tipo" class="form-input-focus w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                        <option value="">Selecione...</option>
                                        <option value="LV">LV (Baixa Tensão)</option>
                                        <option value="HV">HV (Alta Tensão)</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="battery_capacity" class="block text-sm font-medium text-gray-700 mb-2">Capacidade (kWh)</label>
                                    <input type="text" inputmode="decimal" id="battery_capacity" name="battery_capacity" class="form-input-focus w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label for="battery_min_voltage" class="block text-sm font-medium text-gray-700 mb-2">Tensão Mínima (V)</label>
                                    <input type="text" inputmode="decimal" id="battery_min_voltage" name="battery_min_voltage" class="form-input-focus w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label for="battery_max_voltage" class="block text-sm font-medium text-gray-700 mb-2">Tensão Máxima (V)</label>
                                    <input type="text" inputmode="decimal" id="battery_max_voltage" name="battery_max_voltage" class="form-input-focus w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label for="max_battery_parallel" class="block text-sm font-medium text-gray-700 mb-2">Máx. em Paralelo</label>
                                    <input type="text" inputmode="numeric" id="max_battery_parallel" name="max_battery_parallel" class="form-input-focus w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                </div>
                            </div>

                            <h4 class="text-lg font-semibold text-blue-700 mb-4 pb-2 border-b-2 border-blue-200 mt-8">
                                <i class="fas fa-tools mr-2"></i>
                                Acessórios Compatíveis
                            </h4>
                            <div id="battery-accessories-container" class="space-y-4"></div>
                            <button type="button" id="add-battery-accessory" class="mt-4 px-6 py-2 bg-blue-500 text-white rounded-xl hover:bg-blue-600 transition-colors duration-200">
                                <i class="fas fa-plus mr-2"></i>
                                Adicionar Acessório
                            </button>
                        </div>

                        <div id="estruturas-fields" class="hidden"></div>
                        <div id="acessorios-baterias-fields" class="hidden"></div>
                        <div id="acessorios-inversores-fields" class="hidden"></div>
                        <div id="other-fields" class="hidden"></div>

                        <div class="text-center mt-8">
                            <button type="submit" id="submit-btn" class="px-8 py-4 bg-gradient-to-r from-green-500 to-green-600 text-white font-semibold rounded-2xl hover:from-green-600 hover:to-green-700 transform hover:scale-105 transition-all duration-300 shadow-lg hover:shadow-xl">
                                <i class="fas fa-save mr-2"></i>
                                Cadastrar Produto
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        function showToast(message, type = 'success') {
            const toastContainer = document.getElementById('toast-container');
            const toast = document.createElement('div');
            const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
            const icon = type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle';
            
            toast.className = `toast ${bgColor} text-white px-6 py-4 rounded-xl shadow-lg flex items-center space-x-3 max-w-sm`;
            toast.innerHTML = `
                <i class="fas ${icon}"></i>
                <span class="font-medium">${message}</span>
                <button onclick="this.parentElement.remove()" class="ml-auto text-white hover:text-gray-200" aria-label="Fechar notificação">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            toastContainer.appendChild(toast);
            
            setTimeout(() => toast.classList.add('show'), 100);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 5000);
        }

        function setLoading(isLoading) {
            const submitBtn = document.getElementById('submit-btn');
            if (isLoading) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner loading-spinner mr-2"></i>Cadastrando...';
                submitBtn.classList.add('opacity-75');
            } else {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-save mr-2"></i>Cadastrar Produto';
                submitBtn.classList.remove('opacity-75');
            }
        }

        const supabaseUrl = 'https://fuwaybwljyrmkpjuuyoa.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ1d2F5YndsanlybWtwanV1eW9hIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgzMDk1NDYsImV4cCI6MjA3Mzg4NTU0Nn0.21CYoRHG7EjXkzjhfQB8mVO6IYdYJF7cdyMbwQKyldU';
        const { createClient } = supabase;
        const supabaseClient = createClient(supabaseUrl, supabaseKey);

        const manufacturerSelect = document.getElementById('manufacturer');
        const productCards = document.querySelectorAll('.product-card');
        const formFieldsContainer = document.getElementById('form-fields-container');
        const productTypeInput = document.getElementById('productType');
        
        const inverterFields = document.getElementById('inverter-fields');
        const moduleFields = document.getElementById('module-fields');
        const batteryFields = document.getElementById('battery-fields');
        const estruturasFields = document.getElementById('estruturas-fields');
        const acessoriosBateriasFields = document.getElementById('acessorios-baterias-fields');
        const acessoriosInversoresFields = document.getElementById('acessorios-inversores-fields');
        const otherFields = document.getElementById('other-fields');
        
        const inverterTypeSelect = document.getElementById('inverter_type');
        const advancedInverterFields = document.getElementById('advanced-inverter-fields');
        const mpptSection = document.getElementById('mppt-section');
        const mpptContainer = document.getElementById('mppt-container');
        const addMpptBtn = document.getElementById('add-mppt');

        const moduleDimensionsField = document.getElementById('module_dimensions_field');
        const frameField = document.getElementById('frame_field');
        const warrantyField = document.getElementById('warranty_field');
        const batteryWarrantyFields = document.getElementById('battery-warranty-fields');

        const batterySearchInput = document.getElementById('battery-search');
        const suggestionsList = document.getElementById('suggestions-list');
        const selectedBatteriesContainer = document.getElementById('selected-batteries-container');
        const hiddenBatteriesInput = document.getElementById('compatible_batteries');

        const redeTagsContainer = document.getElementById('rede-tags-container');
        const redeHiddenInput = document.getElementById('rede-hidden-input');
        const voltageTagsContainer = document.getElementById('voltage-tags-container');
        const voltageHiddenInput = document.getElementById('voltage-hidden-input');

        const addBatteryAccessoryBtn = document.getElementById('add-battery-accessory');
        const batteryAccessoriesContainer = document.getElementById('battery-accessories-container');
        
        let selectedRedes = new Set();
        let selectedVoltages = new Set();
        let allBatteries = [];
        let selectedBatteryIds = new Set();
        let allAccessories = [];

        const networkOptions = ['Monofásico', 'Bifásico', 'Trifásico'];
        const voltageMap = {
            'Monofásico': ['127V', '220V'],
            'Bifásico': ['127/220V'],
            'Trifásico': ['127/220V', '220/380V']
        };

        // -------- HELPER FUNCTIONS FOR FORMATTING AND VALIDATION --------

        function limitInput(input, maxLength) {
            let value = input.value.replace(/\D/g, ''); 
            if (value.length > maxLength) {
                input.value = value.slice(0, maxLength);
            }
        }

        function formatInteger(input, maxLength = null) {
            let value = input.value.replace(/\D/g, '');
            if (maxLength && value.length > maxLength) {
                value = value.slice(0, maxLength);
            }
            if (value === '') {
                input.value = '';
                return;
            }
            input.value = parseInt(value, 10).toLocaleString('pt-BR');
        }

        function formatErpCode(input) {
            let value = input.value.replace(/\D/g, '');
            if (value.length > 8) value = value.slice(0, 8);
            if (value.length > 4) {
                value = value.slice(0, 4) + '.' + value.slice(4);
            }
            input.value = value;
        }

        function formatDecimal(input) {
            let value = input.value.replace(/\D/g, '');
            if (value === '') {
                input.value = '';
                return;
            }
            value = BigInt(value).toString(); 

            let formattedValue;
            if (value.length <= 2) {
                formattedValue = '0.' + value.padStart(2, '0');
            } else {
                const intPart = value.slice(0, -2);
                const decPart = value.slice(-2);
                formattedValue = `${intPart}.${decPart}`;
            }
            input.value = formattedValue;
        }

        function getNumericValue(inputElement) {
            if (!inputElement || !inputElement.value) return null;
            const value = String(inputElement.value);

            if (value.includes('.') && value.includes(',')) {
                return parseFloat(value.replace(/\./g, '').replace(',', '.'));
            }
            if (value.includes('.') && value.indexOf('.') < value.length - 3) {
                 return parseFloat(value.replace(/\./g, ''));
            }
            const cleanedValue = value.replace(',', '.');
            const number = parseFloat(cleanedValue);
            return isNaN(number) ? null : number;
        }

        // --- END OF HELPER FUNCTIONS ---

        async function loadManufacturers() {
            try {
                const { data, error } = await supabaseClient.from('marcas').select('nome').order('nome', { ascending: true });
                if (error) throw error;
                manufacturerSelect.innerHTML = '<option value="">Selecione...</option>';
                data.forEach(brand => {
                    const option = document.createElement('option');
                    option.value = brand.nome;
                    option.textContent = brand.nome;
                    manufacturerSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Erro ao carregar fabricantes:', error);
                manufacturerSelect.innerHTML = '<option value="">Erro ao carregar</option>';
                showToast('Erro ao carregar fabricantes', 'error');
            }
        }

        async function loadAllBatteries() {
            try {
                const { data, error } = await supabaseClient.from('produtos').select('id, modelo, fabricante').eq('tipo', 'baterias').order('modelo', { ascending: true });
                if (error) throw error;
                allBatteries = data;
            } catch (error) {
                console.error('Erro ao carregar baterias:', error);
                showToast('Erro ao carregar lista de baterias.', 'error');
            }
        }

        async function loadAllAccessories() {
            try {
                const { data, error } = await supabaseClient.from('produtos').select('id, modelo, fabricante').eq('tipo', 'acessorios_baterias').order('modelo', { ascending: true });
                if (error) throw error;
                allAccessories = data;
            } catch (error) {
                console.error('Erro ao carregar acessórios:', error);
                showToast('Erro ao carregar lista de acessórios.', 'error');
            }
        }

        productCards.forEach(card => {
            card.addEventListener('click', () => {
                productCards.forEach(c => {
                    c.classList.remove('border-blue-500', 'bg-blue-50', 'shadow-xl');
                    c.setAttribute('aria-checked', 'false');
                });
                card.classList.add('border-blue-500', 'bg-blue-50', 'shadow-xl');
                card.setAttribute('aria-checked', 'true');
                const selectedType = card.getAttribute('data-product-type');
                productTypeInput.value = selectedType;
                formFieldsContainer.classList.remove('hidden');
                
                const allFieldSections = [inverterFields, moduleFields, batteryFields, estruturasFields, acessoriosBateriasFields, acessoriosInversoresFields, otherFields, moduleDimensionsField, frameField, warrantyField, batteryWarrantyFields];
                allFieldSections.forEach(el => el.classList.add('hidden'));
                
                if (selectedType === 'baterias') {
                    batteryFields.classList.remove('hidden');
                    batteryWarrantyFields.classList.remove('hidden');
                } else if (selectedType === 'inversores') {
                    inverterFields.classList.remove('hidden');
                    warrantyField.classList.remove('hidden');
                } else if (selectedType === 'modulos') {
                    moduleFields.classList.remove('hidden');
                    moduleDimensionsField.classList.remove('hidden');
                    frameField.classList.remove('hidden');
                    warrantyField.classList.remove('hidden');
                } else {
                    warrantyField.classList.remove('hidden');
                    const specificField = document.getElementById(`${selectedType}-fields`);
                    if(specificField) specificField.classList.remove('hidden');
                }
            });
        });

        inverterTypeSelect.addEventListener('change', (e) => {
            const selectedInverterType = e.target.value;
            advancedInverterFields.classList.add('hidden');
            mpptSection.classList.add('hidden');
            mpptContainer.innerHTML = '';
            
            if (['On-Grid', 'Micro Inversor On-Grid'].includes(selectedInverterType)) {
                mpptSection.classList.remove('hidden');
            } else if (['Hibrido', 'Micro Inversor Hibrido', 'String Off Grid'].includes(selectedInverterType)) {
                advancedInverterFields.classList.remove('hidden');
                mpptSection.classList.remove('hidden');
            }
        });

        function populateRedeTags() {
            redeTagsContainer.innerHTML = '';
            networkOptions.forEach(rede => {
                const tag = document.createElement('span');
                tag.dataset.value = rede;
                tag.classList.add('rede-tag', 'cursor-pointer', 'px-3', 'py-1', 'rounded-full', 'bg-gray-200', 'text-gray-700', 'hover:bg-blue-100', 'hover:text-blue-700', 'transition-colors', 'duration-200');
                tag.textContent = rede;
                redeTagsContainer.appendChild(tag);
            });
        }
        
        redeTagsContainer.addEventListener('click', (e) => {
            const tag = e.target.closest('.rede-tag');
            if (tag) {
                const rede = tag.dataset.value;
                if (selectedRedes.has(rede)) {
                    selectedRedes.delete(rede);
                    tag.classList.remove('bg-blue-600', 'text-white');
                } else {
                    selectedRedes.add(rede);
                    tag.classList.add('bg-blue-600', 'text-white');
                }
                updateRedeHiddenInput();
                updateVoltageTags();
            }
        });
        
        function updateRedeHiddenInput() {
            redeHiddenInput.value = JSON.stringify(Array.from(selectedRedes));
        }

        function updateVoltageTags() {
            voltageTagsContainer.innerHTML = '';
            selectedVoltages.clear();
            if (selectedRedes.size === 0) {
                voltageTagsContainer.innerHTML = '<span class="text-gray-400 text-sm">Selecione a rede primeiro...</span>';
                updateVoltageHiddenInput();
                return;
            }
            const allPossibleVoltages = new Set();
            selectedRedes.forEach(rede => {
                if (voltageMap[rede]) {
                    voltageMap[rede].forEach(voltage => allPossibleVoltages.add(voltage));
                }
            });
            Array.from(allPossibleVoltages).forEach(voltage => {
                const tag = document.createElement('span');
                tag.dataset.value = voltage;
                tag.classList.add('voltage-tag', 'cursor-pointer', 'px-3', 'py-1', 'rounded-full', 'bg-gray-200', 'text-gray-700', 'hover:bg-blue-100', 'hover:text-blue-700', 'transition-colors', 'duration-200');
                tag.textContent = voltage;
                tag.addEventListener('click', () => {
                    if (selectedVoltages.has(voltage)) {
                        selectedVoltages.delete(voltage);
                        tag.classList.remove('bg-blue-600', 'text-white');
                    } else {
                        selectedVoltages.add(voltage);
                        tag.classList.add('bg-blue-600', 'text-white');
                    }
                    updateVoltageHiddenInput();
                });
                voltageTagsContainer.appendChild(tag);
            });
            updateVoltageHiddenInput();
        }

        function updateVoltageHiddenInput() {
            voltageHiddenInput.value = JSON.stringify(Array.from(selectedVoltages));
        }

        function updateMpptLabels() {
            const mpptGroups = mpptContainer.querySelectorAll('.mppt-group');
            mpptGroups.forEach((group, index) => {
                const label = group.querySelector('span.absolute');
                if (label) {
                    label.textContent = `MPPT ${index + 1}`;
                }
            });
        }

        addMpptBtn.addEventListener('click', () => {
            const newMpptIndex = mpptContainer.querySelectorAll('.mppt-group').length + 1;
            const mpptDiv = document.createElement('div');
            mpptDiv.classList.add('mppt-group', 'relative', 'p-4', 'mt-4', 'border', 'border-gray-200', 'rounded-xl', 'bg-gray-50');
            mpptDiv.innerHTML = `
                <span class="absolute -top-3 left-4 bg-white px-2 text-sm text-gray-600 font-medium">MPPT ${newMpptIndex}</span>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Qtd de Entradas</label>
                        <input type="text" inputmode="numeric" name="mppt_entradas" class="form-input-focus w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Corrente Máx. Operação (A)</label>
                        <input type="text" inputmode="decimal" name="mppt_max_op_current" class="form-input-focus w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Corrente Máx. Curto (A)</label>
                        <input type="text" inputmode="decimal" name="mppt_max_short_current" class="form-input-focus w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Potência Nominal do MPPT (W)</label>
                        <input type="text" inputmode="numeric" name="mppt_nominal_power" class="form-input-focus w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                </div>
                <button type="button" class="absolute -top-2 -right-2 w-8 h-8 bg-red-500 text-white rounded-full hover:bg-red-600 transition-colors duration-200 remove-mppt flex items-center justify-center" aria-label="Remover MPPT">
                    <i class="fas fa-times text-sm"></i>
                </button>
            `;
            
            mpptDiv.querySelector('[name="mppt_entradas"]').addEventListener('input', e => limitInput(e.target, 2));
            mpptDiv.querySelector('[name="mppt_max_op_current"]').addEventListener('input', e => formatDecimal(e.target));
            mpptDiv.querySelector('[name="mppt_max_short_current"]').addEventListener('input', e => formatDecimal(e.target));
            mpptDiv.querySelector('[name="mppt_nominal_power"]').addEventListener('input', e => formatInteger(e.target));

            mpptContainer.appendChild(mpptDiv);

            mpptDiv.querySelector('.remove-mppt').addEventListener('click', () => {
                mpptDiv.remove();
                updateMpptLabels();
            });
        });
        
        batterySearchInput.addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            suggestionsList.innerHTML = '';
            if (query.length > 0) {
                const filteredBatteries = allBatteries.filter(battery => 
                    !selectedBatteryIds.has(battery.id) && 
                    (battery.modelo.toLowerCase().includes(query) || battery.fabricante.toLowerCase().includes(query))
                );
                if (filteredBatteries.length > 0) {
                    suggestionsList.classList.remove('hidden');
                    filteredBatteries.forEach(battery => {
                        const suggestionItem = document.createElement('div');
                        suggestionItem.dataset.id = battery.id;
                        suggestionItem.dataset.name = `${battery.modelo} (${battery.fabricante})`;
                        suggestionItem.classList.add('px-4', 'py-2', 'cursor-pointer', 'hover:bg-blue-100', 'transition-colors', 'duration-150');
                        suggestionItem.textContent = `${battery.modelo} (${battery.fabricante})`;
                        suggestionsList.appendChild(suggestionItem);
                    });
                } else {
                    suggestionsList.classList.add('hidden');
                }
            } else {
                suggestionsList.classList.add('hidden');
            }
        });

        suggestionsList.addEventListener('click', (e) => {
            const selectedItem = e.target.closest('div');
            if (selectedItem) {
                const batteryId = selectedItem.dataset.id;
                const batteryName = selectedItem.dataset.name;
                if (!selectedBatteryIds.has(batteryId)) {
                    addBatteryTag(batteryId, batteryName);
                    selectedBatteryIds.add(batteryId);
                    updateBatteryHiddenInput();
                }
                batterySearchInput.value = '';
                suggestionsList.classList.add('hidden');
            }
        });

        function addBatteryTag(id, name) {
            const tag = document.createElement('span');
            tag.dataset.id = id;
            tag.classList.add('inline-flex', 'items-center', 'px-3', 'py-1', 'rounded-full', 'bg-blue-100', 'text-blue-800', 'text-sm', 'font-medium', 'whitespace-nowrap', 'tag-item');
            tag.innerHTML = `
                ${name}
                <button type="button" class="ml-2 text-blue-500 hover:text-blue-700 focus:outline-none" aria-label="Remover bateria">
                    <i class="fas fa-times text-xs"></i>
                </button>
            `;
            selectedBatteriesContainer.appendChild(tag);
            tag.querySelector('button').addEventListener('click', () => {
                tag.remove();
                selectedBatteryIds.delete(id);
                updateBatteryHiddenInput();
            });
        }
        
        function updateBatteryHiddenInput() {
            hiddenBatteriesInput.value = JSON.stringify(Array.from(selectedBatteryIds));
        }

        addBatteryAccessoryBtn.addEventListener('click', () => {
            const accessoryDiv = document.createElement('div');
            accessoryDiv.classList.add('battery-accessory-group', 'relative', 'p-4', 'mt-4', 'border', 'border-gray-200', 'rounded-xl', 'bg-gray-50');
            accessoryDiv.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="relative col-span-1 md:col-span-2 lg:col-span-1">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Acessório</label>
                        <input type="text" class="form-input-focus w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent accessory-search-input" placeholder="Buscar acessório...">
                        <div class="absolute z-10 w-full mt-1 bg-white border border-gray-200 rounded-xl shadow-lg max-h-48 overflow-y-auto hidden suggestions-list-accessory"></div>
                        <input type="hidden" class="accessory-id-input">
                    </div>
                    <div class="flex items-end gap-2 col-span-1 md:col-span-2 lg:col-span-2">
                        <div class="flex-grow">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs font-medium text-gray-500 mb-1">Qtd.</label>
                                    <input type="number" step="any" class="form-input-focus w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent accessory-qty-input">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-500 mb-1">a cada</label>
                                    <input type="number" step="any" class="form-input-focus w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent accessory-per-qty-input">
                                </div>
                            </div>
                        </div>
                        <div class="self-end pb-3">
                            <label class="flex items-center space-x-2 text-sm font-medium text-gray-700 cursor-pointer">
                                <input type="checkbox" class="form-checkbox h-5 w-5 text-blue-600 rounded-md border-gray-300 focus:ring-blue-500 respect-voltage-check">
                                <span>Respeitar Tensão do Inversor</span>
                            </label>
                        </div>
                    </div>
                </div>
                <button type="button" class="absolute -top-2 -right-2 w-8 h-8 bg-red-500 text-white rounded-full hover:bg-red-600 transition-colors duration-200 remove-accessory flex items-center justify-center" aria-label="Remover acessório">
                    <i class="fas fa-times text-sm"></i>
                </button>
            `;
            batteryAccessoriesContainer.appendChild(accessoryDiv);

            const accessorySearchInput = accessoryDiv.querySelector('.accessory-search-input');
            const accessorySuggestionsList = accessoryDiv.querySelector('.suggestions-list-accessory');
            const accessoryIdInput = accessoryDiv.querySelector('.accessory-id-input');

            accessorySearchInput.addEventListener('input', (e) => {
                const query = e.target.value.toLowerCase();
                accessorySuggestionsList.innerHTML = '';
                if (query.length > 0) {
                    const filteredAccessories = allAccessories.filter(acc => acc.modelo.toLowerCase().includes(query) || acc.fabricante.toLowerCase().includes(query));
                    if (filteredAccessories.length > 0) {
                        accessorySuggestionsList.classList.remove('hidden');
                        filteredAccessories.forEach(accessory => {
                            const suggestionItem = document.createElement('div');
                            suggestionItem.dataset.id = accessory.id;
                            suggestionItem.dataset.name = `${accessory.modelo} (${accessory.fabricante})`;
                            suggestionItem.classList.add('px-4', 'py-2', 'cursor-pointer', 'hover:bg-blue-100', 'transition-colors', 'duration-150');
                            suggestionItem.textContent = `${accessory.modelo} (${accessory.fabricante})`;
                            accessorySuggestionsList.appendChild(suggestionItem);
                        });
                    } else {
                        accessorySuggestionsList.classList.add('hidden');
                    }
                } else {
                    accessorySuggestionsList.classList.add('hidden');
                }
            });

            accessorySuggestionsList.addEventListener('click', (e) => {
                const selectedItem = e.target.closest('div');
                if (selectedItem) {
                    const accessoryId = selectedItem.dataset.id;
                    const accessoryName = selectedItem.dataset.name;
                    accessoryIdInput.value = accessoryId;
                    accessorySearchInput.value = accessoryName;
                    accessorySuggestionsList.classList.add('hidden');
                }
            });

            accessoryDiv.querySelector('.remove-accessory').addEventListener('click', () => {
                accessoryDiv.remove();
            });
        });


        document.getElementById('product-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const productType = productTypeInput.value;
            if (!productType) {
                showToast('Por favor, selecione um tipo de produto.', 'error');
                return;
            }

            setLoading(true);

            try {
                const generalData = {
                    modelo: document.getElementById('model').value,
                    fabricante: document.getElementById('manufacturer').value,
                    tipo: productType,
                    garantia: productType === 'baterias' ? null : getNumericValue(document.getElementById('warranty')),
                    codigo_erp: document.getElementById('erp_code').value,
                    dimensoes: document.getElementById('module_dimensions').value || null,
                    frame: document.getElementById('frame').value || null,
                    description: document.getElementById('description').value
                };

                const { data: produtoInserido, error: produtoError } = await supabaseClient
                    .from('produtos')
                    .insert([generalData])
                    .select();

                if (produtoError) {
                    throw new Error(produtoError.message);
                }
                
                const produtoId = produtoInserido[0].id;
                let detalhesData = {};
                let tabelaDetalhes = '';
                
                if (productType === 'inversores') {
                    tabelaDetalhes = 'inversores';
                    const compatibleBatteries = Array.from(selectedBatteryIds);
                    const selectedVoltagesArray = JSON.parse(voltageHiddenInput.value || '[]');
                    const selectedRedesArray = JSON.parse(redeHiddenInput.value || '[]');

                    const inverterType = document.getElementById('inverter_type').value;
                    detalhesData = {
                        produto_id: produtoId,
                        tipo_inversor: inverterType,
                        nominal_power: getNumericValue(document.getElementById('nominal_power')),
                        start_voltage: getNumericValue(document.getElementById('start_voltage')),
                        min_op_voltage: getNumericValue(document.getElementById('min_op_voltage')),
                        max_op_voltage: getNumericValue(document.getElementById('max_op_voltage')),
                        isolation_voltage: getNumericValue(document.getElementById('isolation_voltage')),
                        rede: selectedRedesArray,
                        voltage: selectedVoltagesArray,
                        overload: getNumericValue(document.getElementById('overload')),
                        min_bat_voltage: getNumericValue(document.getElementById('min_bat_voltage')),
                        max_bat_voltage: getNumericValue(document.getElementById('max_bat_voltage')),
                        max_parallel: getNumericValue(document.getElementById('max_parallel'))
                    };

                    if (['Hibrido', 'Micro Inversor Hibrido', 'String Off Grid'].includes(inverterType)) {
                        detalhesData.baterias_compativeis = compatibleBatteries.length > 0 ? compatibleBatteries : null;
                    }

                    const mpptGroups = mpptContainer.querySelectorAll('.mppt-group');
                    if (mpptGroups.length > 0) {
                        const mpptDataArray = [];
                        mpptGroups.forEach(group => {
                            mpptDataArray.push({
                                entradas: getNumericValue(group.querySelector('[name="mppt_entradas"]')),
                                max_op_current: getNumericValue(group.querySelector('[name="mppt_max_op_current"]')),
                                max_short_current: getNumericValue(group.querySelector('[name="mppt_max_short_current"]')),
                                nominal_power: getNumericValue(group.querySelector('[name="mppt_nominal_power"]'))
                            });
                        });
                        detalhesData.mppt_data = mpptDataArray;
                    }

                } else if (productType === 'modulos') {
                    tabelaDetalhes = 'modulos';
                    detalhesData = {
                        produto_id: produtoId,
                        power_wp: getNumericValue(document.getElementById('module_power_wp')),
                        voltage_vmp: getNumericValue(document.getElementById('module_voltage_vmp')),
                        voltage_voc: getNumericValue(document.getElementById('module_voltage_voc')),
                        current_imp: getNumericValue(document.getElementById('module_current_imp')),
                        current_isc: getNumericValue(document.getElementById('module_current_isc')),
                    };
                } else if (productType === 'baterias') {
                    tabelaDetalhes = 'baterias';
                    const accessories = [];
                    batteryAccessoriesContainer.querySelectorAll('.battery-accessory-group').forEach(group => {
                        const accessoryId = group.querySelector('.accessory-id-input').value;
                        const qty = getNumericValue(group.querySelector('.accessory-qty-input'));
                        const perQty = getNumericValue(group.querySelector('.accessory-per-qty-input'));
                        const respectVoltage = group.querySelector('.respect-voltage-check').checked;
                        if (accessoryId) {
                            accessories.push({
                                id: accessoryId,
                                regra: { quantidade: qty, a_cada: perQty, respect_inverter_voltage: respectVoltage }
                            });
                        }
                    });

                    detalhesData = {
                        produto_id: produtoId,
                        tipo_bateria: document.getElementById('battery_type').value,
                        tensao_tipo: document.getElementById('tensao_tipo').value,
                        capacity: getNumericValue(document.getElementById('battery_capacity')),
                        min_voltage: getNumericValue(document.getElementById('battery_min_voltage')),
                        max_voltage: getNumericValue(document.getElementById('battery_max_voltage')),
                        garantia_anos: getNumericValue(document.getElementById('warranty_years')),
                        garantia_ciclos: getNumericValue(document.getElementById('warranty_cycles')),
                        max_parallel: getNumericValue(document.getElementById('max_battery_parallel')),
                        acessorios_compativeis: accessories.length > 0 ? accessories : null
                    };
                }

                if (tabelaDetalhes) {
                    const { error: detalhesError } = await supabaseClient
                        .from(tabelaDetalhes)
                        .insert([detalhesData]);

                    if (detalhesError) {
                        await supabaseClient.from('produtos').delete().eq('id', produtoId);
                        throw new Error(detalhesError.message);
                    }
                }

                showToast('Produto cadastrado com sucesso!', 'success');
                document.getElementById('product-form').reset();
                formFieldsContainer.classList.add('hidden');
                productCards.forEach(c => c.classList.remove('border-blue-500', 'bg-blue-50', 'shadow-xl'));
                
                selectedBatteryIds.clear();
                updateBatteryHiddenInput();
                selectedBatteriesContainer.innerHTML = '';
                batteryAccessoriesContainer.innerHTML = '';
                
            } catch (error) {
                console.error('Erro ao cadastrar produto:', error);
                showToast('Erro ao cadastrar produto: ' + error.message, 'error');
            } finally {
                setLoading(false);
            }
        });
        
        function applyInputFormattingListeners() {
            document.getElementById('erp_code').addEventListener('input', (e) => formatErpCode(e.target));
            document.getElementById('warranty').addEventListener('input', (e) => limitInput(e.target, 2));
            document.getElementById('warranty_years').addEventListener('input', (e) => limitInput(e.target, 2));
            document.getElementById('overload').addEventListener('input', (e) => limitInput(e.target, 3));
            document.getElementById('max_parallel').addEventListener('input', (e) => limitInput(e.target, 2));
            document.getElementById('max_battery_parallel').addEventListener('input', (e) => limitInput(e.target, 3));

            const integerFields = ['nominal_power', 'module_power_wp'];
            integerFields.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.addEventListener('input', (e) => formatInteger(e.target));
                }
            });
            
            const warrantyCyclesEl = document.getElementById('warranty_cycles');
            if (warrantyCyclesEl) {
                warrantyCyclesEl.addEventListener('input', (e) => formatInteger(e.target, 4));
            }

            const decimalFields = [
                'start_voltage', 'min_op_voltage', 'max_op_voltage', 'isolation_voltage',
                'min_bat_voltage', 'max_bat_voltage', 'module_voltage_vmp', 'module_voltage_voc',
                'module_current_imp', 'module_current_isc', 'battery_capacity', 'battery_min_voltage',
                'battery_max_voltage'
            ];
            decimalFields.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.addEventListener('input', (e) => formatDecimal(e.target));
                }
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadManufacturers();
            loadAllBatteries();
            loadAllAccessories();
            populateRedeTags();
            applyInputFormattingListeners();
        });
    </script>

    <style>
        .loading-spinner {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .toast {
            transform: translateX(100%);
            transition: transform 0.3s ease-in-out;
        }
        
        .toast.show {
            transform: translateX(0);
        }
        
        .form-input-focus:focus-within {
            outline: none;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5); /* ring-2 */
            border-color: transparent;
        }
    </style>
</body>
</html>